<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ì¶¤ ì•µê¸€ ì œì‘ ì‹œë®¬ë ˆì´í„°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;       /* ì‹ ë¢°ê° ì£¼ëŠ” ë¸”ë£¨ */
            --primary-hover: #1d4ed8;
            --bg-body: #f3f4f6;       /* ë°ì€ íšŒìƒ‰ ë°°ê²½ */
            --bg-panel: #ffffff;      /* í°ìƒ‰ íŒ¨ë„ */
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* ì™¼ìª½ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .sidebar {
            width: 400px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: var(--shadow);
        }

        .header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: var(--text-sub);
        }

        .controls {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sub);
            margin-bottom: 8px;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            cursor: pointer;
        }

        .number-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            text-align: right;
            transition: border-color 0.2s;
        }

        .number-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ê²¬ì  ìš”ì•½ ì„¹ì…˜ */
        .summary {
            background: #f8fafc;
            padding: 24px;
            border-top: 1px solid var(--border);
        }

        .price-tag {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .price-label {
            font-size: 14px;
            color: var(--text-sub);
            font-weight: 500;
        }

        .price-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            grid-column: span 2;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        /* 3D ìº”ë²„ìŠ¤ ì˜ì—­ */
        .viewer {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        .viewer-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.9);
            padding: 16px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(4px);
            font-size: 12px;
            color: var(--text-sub);
            pointer-events: none;
        }
        
        .viewer-controls b {
            color: var(--text-main);
        }

        /* íˆ´íŒ */
        .dimension-badge {
            position: absolute;
            background: rgba(17, 24, 39, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            user-select: none;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h1>ì•µê¸€ ì œì‘ ì‹œë®¬ë ˆì´í„°</h1>
            <p>ì›í•˜ëŠ” ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•˜ì—¬ ê²¬ì ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>

        <div class="controls">
            <div class="input-group">
                <label>ê°€ë¡œ (Width)</label>
                <div class="range-wrap">
                    <input type="range" min="400" max="2400" step="100" id="range-w" value="1200">
                    <input type="number" class="number-input" id="input-w" value="1200"> mm
                </div>
            </div>

            <div class="input-group">
                <label>ê¹Šì´ (Depth)</label>
                <div class="range-wrap">
                    <input type="range" min="300" max="1200" step="100" id="range-d" value="600">
                    <input type="number" class="number-input" id="input-d" value="600"> mm
                </div>
            </div>

            <div class="input-group">
                <label>ë†’ì´ (Height)</label>
                <div class="range-wrap">
                    <input type="range" min="600" max="2400" step="100" id="range-h" value="1800">
                    <input type="number" class="number-input" id="input-h" value="1800"> mm
                </div>
            </div>

            <div class="input-group">
                <label>ì„ ë°˜ ë‹¨ìˆ˜ (Shelves)</label>
                <div class="range-wrap">
                    <input type="range" min="2" max="8" step="1" id="range-s" value="5">
                    <input type="number" class="number-input" id="input-s" value="5"> ë‹¨
                </div>
            </div>
            
            <div style="margin-top:20px; padding:15px; background:#eff6ff; border-radius:8px; font-size:13px; color:#1e40af;">
                ğŸ’¡ <strong>íŒ:</strong> ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ìœ¼ë¡œ íšŒì „, ì˜¤ë¥¸ìª½ ë²„íŠ¼ìœ¼ë¡œ ì´ë™, íœ ë¡œ í™•ëŒ€/ì¶•ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div class="summary">
            <div class="price-tag">
                <span class="price-label">ì˜ˆìƒ ê²¬ì ê°€ (VAT í¬í•¨)</span>
                <span class="price-value" id="total-price">0 ì›</span>
            </div>
            <div class="btn-group">
                <button class="btn-secondary" onclick="resetView()">ë·° ì´ˆê¸°í™”</button>
                <button class="btn-secondary" onclick="captureImage()">ì´ë¯¸ì§€ ì €ì¥</button>
                <button class="btn-primary" onclick="alert('ì£¼ë¬¸ ê¸°ëŠ¥ì€ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.')">ì£¼ë¬¸í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="viewer">
        <div id="canvas-container"></div>
        <div class="viewer-controls">
            <div><b>íšŒì „</b> : ì¢Œí´ë¦­ ë“œë˜ê·¸</div>
            <div><b>ì´ë™</b> : ìš°í´ë¦­ ë“œë˜ê·¸</div>
            <div><b>ì¤Œ</b> : ë§ˆìš°ìŠ¤ íœ </div>
        </div>
    </div>

<script>
    let scene, camera, renderer, furniture, controls;
    let dimensionGroup;

    // ì´ˆê¸°ê°’
    const config = {
        width: 1200,
        depth: 600,
        height: 1800,
        shelves: 5
    };

    // ê°€ê²© ì„¤ì • (ë‹¨ìœ„: ì›)
    const PRICES = {
        anglePerMeter: 3000, // ì•µê¸€ 1më‹¹ ê°€ê²©
        boardPerSqMeter: 25000, // í•©íŒ 1ì œê³±ë¯¸í„°ë‹¹ ê°€ê²©
        bracketSet: 1000 // ì„ ë°˜ë‹¹ ë³¼íŠ¸/ë„ˆíŠ¸/ì‚¼ê°ëŒ€ ë¹„ìš©
    };

    function init() {
        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf3f4f6); // ë¶€ë“œëŸ¬ìš´ íšŒìƒ‰ ë°°ê²½

        // Camera
        camera = new THREE.PerspectiveCamera(45, window.innerWidth - 400 / window.innerHeight, 10, 10000);
        camera.position.set(2500, 2000, 2500);

        // Renderer
        const container = document.getElementById('canvas-container');
        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true }); // ìº¡ì²˜ë¥¼ ìœ„í•´ preserveDrawingBuffer true
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Controls (OrbitControls ì‚¬ìš© - í›¨ì”¬ ë¶€ë“œëŸ¬ì›€)
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // ê´€ì„± íš¨ê³¼
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.05; // ë°”ë‹¥ ì•„ë˜ë¡œ ëª» ê°€ê²Œ ì œí•œ
        controls.minDistance = 500;
        controls.maxDistance = 5000;

        // Lights
        setupLights();

        // Floor
        setupFloor();

        // Initial Build
        updateFurniture();

        // Events
        window.addEventListener('resize', onWindowResize);
        setupUIEvents();
        
        animate();
    }

    function setupLights() {
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
        mainLight.position.set(1000, 2000, 1000);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        mainLight.shadow.camera.near = 0.5;
        mainLight.shadow.camera.far = 5000;
        
        // ê·¸ë¦¼ì ë²”ìœ„ í™•ì¥
        const d = 2000;
        mainLight.shadow.camera.left = -d;
        mainLight.shadow.camera.right = d;
        mainLight.shadow.camera.top = d;
        mainLight.shadow.camera.bottom = -d;
        
        scene.add(mainLight);

        // ë°˜ì‚¬ê´‘ (Fill Light)
        const fillLight = new THREE.DirectionalLight(0xb0c4de, 0.3);
        fillLight.position.set(-1000, 500, -1000);
        scene.add(fillLight);
    }

    function setupFloor() {
        const geometry = new THREE.PlaneGeometry(10000, 10000);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0xffffff,
            roughness: 0.8,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(geometry, material);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -1; // ëª¨ë¸ ë°”ë‹¥ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ì‚´ì§ ë‚´ë¦¼
        floor.receiveShadow = true;
        scene.add(floor);

        // Grid (ì‹œê°ì  ê°€ì´ë“œ)
        const gridHelper = new THREE.GridHelper(4000, 40, 0xccd5ae, 0xe5e7eb);
        gridHelper.position.y = 0;
        gridHelper.material.opacity = 0.5;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);
    }

    function createFurniture() {
        if (furniture) scene.remove(furniture);
        furniture = new THREE.Group();

        // Materials
        const angleMaterial = new THREE.MeshStandardMaterial({
            color: 0x2c3e50, // ë‹¤í¬ ë„¤ì´ë¹„/ë¸”ë™ (ì•„ì´ì–¸ ëŠë‚Œ)
            metalness: 0.6,
            roughness: 0.4
        });

        // í•©íŒ í…ìŠ¤ì²˜ ëŠë‚Œì˜ ë¨¸í‹°ë¦¬ì–¼
        const shelfMaterial = new THREE.MeshStandardMaterial({
            color: 0xeebb88, // ë°ì€ ë‚˜ë¬´ìƒ‰
            roughness: 0.8,
            metalness: 0.0
        });

        const { width, depth, height, shelves } = config;
        const angleSize = 40; // 40mm ì•µê¸€
        const angleThick = 3;

        // 1. ê¸°ë‘¥ (4ê°œ)
        const legGeo = new THREE.BoxGeometry(angleSize, height, angleSize); 
        // Lì ëª¨ì–‘ì„ ë‹¨ìˆœí™”í•˜ì—¬ ë°•ìŠ¤ë¡œ í‘œí˜„í•˜ë˜, ì‹¤ì œë¡œëŠ” Lí˜•íƒœ í•¨ìˆ˜ë¥¼ ì“°ë©´ ì¢‹ì§€ë§Œ 
        // ì„±ëŠ¥ê³¼ ì½”ë“œë¥¼ ìœ„í•´ ë°•ìŠ¤ 2ê°œë¥¼ ê²¹ì³ Lìë¥¼ ë§Œë“­ë‹ˆë‹¤.
        
        const createLeg = (x, z, rotY) => {
            const group = new THREE.Group();
            
            const wPart = new THREE.Mesh(new THREE.BoxGeometry(angleSize, height, angleThick), angleMaterial);
            wPart.position.set(0, height/2, -angleSize/2 + angleThick/2);
            wPart.castShadow = true;

            const dPart = new THREE.Mesh(new THREE.BoxGeometry(angleThick, height, angleSize), angleMaterial);
            dPart.position.set(-angleSize/2 + angleThick/2, height/2, 0);
            dPart.castShadow = true;

            group.add(wPart, dPart);
            group.position.set(x, 0, z);
            group.rotation.y = rotY;
            return group;
        };

        const legOffsetW = width/2 - angleSize/2;
        const legOffsetD = depth/2 - angleSize/2;

        furniture.add(createLeg(-legOffsetW, -legOffsetD, 0));             // ì•-ì™¼ìª½
        furniture.add(createLeg(legOffsetW, -legOffsetD, -Math.PI/2));     // ì•-ì˜¤ë¥¸ìª½
        furniture.add(createLeg(-legOffsetW, legOffsetD, Math.PI/2));      // ë’¤-ì™¼ìª½
        furniture.add(createLeg(legOffsetW, legOffsetD, Math.PI));         // ë’¤-ì˜¤ë¥¸ìª½

        // 2. ì„ ë°˜ ë° ê°€ë¡œ ì§€ì§€ëŒ€
        const shelfSpacing = (height - 100) / (shelves - 1); // ìœ„ì•„ë˜ ì—¬ë°± ê³ ë ¤

        for(let i=0; i<shelves; i++) {
            const y = 50 + (i * shelfSpacing); // ë°”ë‹¥ì—ì„œ 50mm ë„ì›€

            // í•©íŒ
            const boardGeo = new THREE.BoxGeometry(width - 5, 12, depth - 5); // 12mm í•©íŒ
            const board = new THREE.Mesh(boardGeo, shelfMaterial);
            board.position.set(0, y + 6, 0); // ì•µê¸€ ìœ„ì— ì–¹í˜
            board.castShadow = true;
            board.receiveShadow = true;
            furniture.add(board);

            // ê°€ë¡œ ì§€ì§€ëŒ€ (í”„ë ˆì„) - ì•/ë’¤
            const frameWGeo = new THREE.BoxGeometry(width, angleSize, angleThick);
            const frameW1 = new THREE.Mesh(frameWGeo, angleMaterial);
            frameW1.position.set(0, y, depth/2 - angleThick/2);
            furniture.add(frameW1);
            
            const frameW2 = new THREE.Mesh(frameWGeo, angleMaterial);
            frameW2.position.set(0, y, -depth/2 + angleThick/2);
            furniture.add(frameW2);

            // ê¹Šì´ ì§€ì§€ëŒ€ (í”„ë ˆì„) - ì¢Œ/ìš°
            const frameDGeo = new THREE.BoxGeometry(angleThick, angleSize, depth);
            const frameD1 = new THREE.Mesh(frameDGeo, angleMaterial);
            frameD1.position.set(width/2 - angleThick/2, y, 0);
            furniture.add(frameD1);

            const frameD2 = new THREE.Mesh(frameDGeo, angleMaterial);
            frameD2.position.set(-width/2 + angleThick/2, y, 0);
            furniture.add(frameD2);
        }

        scene.add(furniture);
        
        // ì¹˜ìˆ˜ì„  ì—…ë°ì´íŠ¸
        updateDimensions();
        // ê°€ê²© ì—…ë°ì´íŠ¸
        calculatePrice();
    }

    function updateDimensions() {
        if (dimensionGroup) furniture.remove(dimensionGroup);
        dimensionGroup = new THREE.Group();

        const { width, depth, height } = config;
        const color = 0x2563eb; // Blue
        const offset = 100;

        // ì¹˜ìˆ˜ì„  ê·¸ë¦¬ê¸° í•¨ìˆ˜
        const drawDim = (start, end, text, textPosOffset) => {
            const material = new THREE.LineBasicMaterial({ color: color });
            const points = [start, end];
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);
            
            // ëì  ë§ˆì»¤ (ì§§ì€ ì„ )
            const markerSize = 20;
            // ... (ë§ˆì»¤ êµ¬í˜„ ìƒëµ, ì‹¬í”Œí•˜ê²Œ ë¼ì¸ë§Œ)
            
            // í…ìŠ¤íŠ¸ ìŠ¤í”„ë¼ì´íŠ¸
            const sprite = createTextSprite(text);
            const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
            sprite.position.copy(mid).add(textPosOffset);
            
            dimensionGroup.add(line);
            dimensionGroup.add(sprite);
        };

        // ê°€ë¡œ ì¹˜ìˆ˜ (ë°”ë‹¥ ì•ìª½)
        drawDim(
            new THREE.Vector3(-width/2, 0, depth/2 + offset),
            new THREE.Vector3(width/2, 0, depth/2 + offset),
            `${width}mm`,
            new THREE.Vector3(0, 0, 50)
        );

        // ë†’ì´ ì¹˜ìˆ˜ (ì™¼ìª½ ì•)
        drawDim(
            new THREE.Vector3(-width/2 - offset, 0, depth/2),
            new THREE.Vector3(-width/2 - offset, height, depth/2),
            `${height}mm`,
            new THREE.Vector3(-50, 0, 0)
        );

        // ê¹Šì´ ì¹˜ìˆ˜ (ì˜¤ë¥¸ìª½ ë°”ë‹¥)
        drawDim(
            new THREE.Vector3(width/2 + offset, 0, -depth/2),
            new THREE.Vector3(width/2 + offset, 0, depth/2),
            `${depth}mm`,
            new THREE.Vector3(50, 0, 0)
        );

        furniture.add(dimensionGroup);
    }

    function createTextSprite(message) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 128;
        
        // ë°°ê²½ ë°•ìŠ¤ (ë‘¥ê·¼ ì‚¬ê°í˜•)
        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        ctx.beginPath();
        ctx.roundRect(10, 30, 236, 68, 15);
        ctx.fill();
        ctx.strokeStyle = "#2563eb";
        ctx.lineWidth = 4;
        ctx.stroke();

        // í…ìŠ¤íŠ¸
        ctx.font = "bold 40px 'Noto Sans KR'";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#1e3a8a";
        ctx.fillText(message, 128, 64);

        const texture = new THREE.Texture(canvas);
        texture.needsUpdate = true;
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
        sprite.scale.set(300, 150, 1);
        return sprite;
    }

    function calculatePrice() {
        const { width, depth, height, shelves } = config;
        
        // 1. ê¸°ë‘¥ ê¸¸ì´ (4ê°œ)
        const postLength = height * 4;
        
        // 2. ê°€ë¡œ/ê¹Šì´ í”„ë ˆì„ ê¸¸ì´ (ë‹¨ìˆ˜ * 2ê°œì”©)
        const frameLength = (width * 2 + depth * 2) * shelves;
        
        // ì´ ì•µê¸€ ê¸¸ì´ (m í™˜ì‚°)
        const totalAngleMeter = (postLength + frameLength) / 1000;
        
        // 3. í•©íŒ ë©´ì  (m2 í™˜ì‚°)
        const boardArea = (width * depth * shelves) / 1000000;

        // ê°€ê²© ê³„ì‚°
        let total = (totalAngleMeter * PRICES.anglePerMeter) + 
                    (boardArea * PRICES.boardPerSqMeter) +
                    (shelves * PRICES.bracketSet);
        
        // 10ì› ë‹¨ìœ„ ì ˆì‚¬ ë° í¬ë§·íŒ…
        total = Math.ceil(total / 100) * 100;
        document.getElementById('total-price').innerText = total.toLocaleString() + " ì›";
    }

    function setupUIEvents() {
        const inputs = ['w', 'd', 'h', 's'];
        const keys = ['width', 'depth', 'height', 'shelves'];

        inputs.forEach((id, index) => {
            const range = document.getElementById(`range-${id}`);
            const number = document.getElementById(`input-${id}`);
            const key = keys[index];

            // Range -> Number & Update
            range.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                number.value = val;
                config[key] = val;
                createFurniture();
            });

            // Number -> Range & Update
            number.addEventListener('change', (e) => {
                let val = parseInt(e.target.value);
                // Min/Max ì²´í¬
                if(val < range.min) val = range.min;
                if(val > range.max) val = range.max;
                
                number.value = val;
                range.value = val;
                config[key] = val;
                createFurniture();
            });
        });
    }

    function onWindowResize() {
        const container = document.getElementById('canvas-container');
        // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ í¬ê¸° ë‹¤ì‹œ ê³„ì‚°
        const w = container.clientWidth;
        const h = container.clientHeight;
        
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    function resetView() {
        controls.reset();
        camera.position.set(2500, 2000, 2500);
    }

    function captureImage() {
        renderer.render(scene, camera);
        const dataURL = renderer.domElement.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = `ì•µê¸€ê²¬ì _${config.width}x${config.depth}x${config.height}.png`;
        link.href = dataURL;
        link.click();
    }

    // Start
    init();

</script>
</body>
</html>
