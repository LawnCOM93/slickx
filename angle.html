<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>맞춤 앵글 제작 시뮬레이터</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f3f4f6;
            --bg-panel: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* 왼쪽 사이드바 */
        .sidebar {
            width: 360px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
        }

        .controls {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 8px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            text-align: right;
            outline: none;
            transition: 0.2s;
        }
        input[type="number"]:focus { border-color: var(--primary); }
        .unit { font-size: 14px; color: var(--text-sub); width: 30px;}

        /* 실행 버튼 스타일 */
        #btn-run {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        #btn-run:hover { background: var(--primary-hover); }
        #btn-run:active { transform: translateY(1px); }

        .summary {
            padding: 24px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
        }
        
        .price-display {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            text-align: right;
            margin-bottom: 10px;
        }
        .price-label { font-size: 14px; color: var(--text-sub); float: left; font-weight: 500;}

        /* 3D 뷰어 영역 */
        .viewer {
            flex: 1;
            position: relative;
            background: #eef2f6;
        }

        #canvas-container { width: 100%; height: 100%; }

        .guide-text {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.8);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            color: #555;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h1>앵글 가구 시뮬레이터</h1>
        </div>

        <div class="controls">
            <div class="input-group">
                <label>가로 (Width)</label>
                <div class="input-row">
                    <input type="number" id="input-w" value="1200" step="100" min="300">
                    <span class="unit">mm</span>
                </div>
            </div>

            <div class="input-group">
                <label>깊이 (Depth)</label>
                <div class="input-row">
                    <input type="number" id="input-d" value="600" step="100" min="300">
                    <span class="unit">mm</span>
                </div>
            </div>

            <div class="input-group">
                <label>높이 (Height)</label>
                <div class="input-row">
                    <input type="number" id="input-h" value="1800" step="100" min="600">
                    <span class="unit">mm</span>
                </div>
            </div>

            <div class="input-group">
                <label>선반 단수 (Shelves)</label>
                <div class="input-row">
                    <input type="number" id="input-s" value="5" step="1" min="2" max="10">
                    <span class="unit">단</span>
                </div>
            </div>

            <button id="btn-run" onclick="updateFurniture()">실행</button>
        </div>

        <div class="summary">
            <div class="price-display">
                <span class="price-label">예상 견적</span>
                <span id="price-value">0</span> 원
            </div>
            <button style="width:100%; padding:10px; border:1px solid #ccc; background:white; border-radius:6px; cursor:pointer;" onclick="downloadImage()">이미지 저장</button>
        </div>
    </div>

    <div class="viewer">
        <div id="canvas-container"></div>
        <div class="guide-text">
            좌클릭: 회전 / 우클릭: 이동 / 휠: 확대축소
        </div>
    </div>

<script>
    let scene, camera, renderer, controls;
    let furnitureGroup; // 가구를 담을 그룹 객체
    let dimGroup;       // 치수선을 담을 그룹 객체

    // 초기화 함수
    function init() {
        const container = document.getElementById('canvas-container');

        // 1. Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xeef2f6); // 밝은 배경색

        // 2. Camera
        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 10, 50000);
        camera.position.set(2500, 2000, 3000);

        // 3. Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // 4. Controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 500;
        controls.maxDistance = 10000;

        // 5. Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(1500, 3000, 1500);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // 6. Floor
        const grid = new THREE.GridHelper(5000, 50, 0xccd5ae, 0xdce2e8);
        scene.add(grid);

        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(10000, 10000),
            new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 1, metalness: 0 })
        );
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = -1;
        plane.receiveShadow = true;
        scene.add(plane);

        // 이벤트 리스너
        window.addEventListener('resize', onWindowResize);

        // 초기 생성
        updateFurniture();
        
        // 애니메이션 시작
        animate();
    }

    // 가구 업데이트 (실행 버튼 클릭 시 호출)
    function updateFurniture() {
        // 기존 가구가 있다면 제거 (메모리 누수 방지)
        if (furnitureGroup) {
            scene.remove(furnitureGroup);
            // 내부 Geometry, Material 메모리 해제
            furnitureGroup.traverse((child) => {
                if (child.isMesh) {
                    child.geometry.dispose();
                    if (Array.isArray(child.material)) {
                        child.material.forEach(m => m.dispose());
                    } else {
                        child.material.dispose();
                    }
                }
            });
        }
        
        if (dimGroup) {
            scene.remove(dimGroup);
        }

        // 입력값 가져오기
        const width = Number(document.getElementById('input-w').value) || 1200;
        const depth = Number(document.getElementById('input-d').value) || 600;
        const height = Number(document.getElementById('input-h').value) || 1800;
        const shelves = Number(document.getElementById('input-s').value) || 5;

        furnitureGroup = new THREE.Group();
        dimGroup = new THREE.Group();

        // ------------------ 모델링 시작 ------------------
        const angleSize = 40; // 앵글 규격 40mm
        const angleThick = 3; // 두께

        // 재질 정의
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x2f3542, roughness: 0.4, metalness: 0.6 }); // 진한 회색 (철)
        const matWood = new THREE.MeshStandardMaterial({ color: 0xdabb94, roughness: 0.8 }); // 나무색

        // 1. 기둥 (4개) - L자 형태를 흉내내기 위해 Box 2개 결합
        const createPost = (x, z, rotY) => {
            const post = new THREE.Group();
            
            // L자의 한쪽 면
            const mesh1 = new THREE.Mesh(new THREE.BoxGeometry(angleSize, height, angleThick), matSteel);
            mesh1.position.set(0, height/2, -angleSize/2 + angleThick/2);
            mesh1.castShadow = true;

            // L자의 다른쪽 면
            const mesh2 = new THREE.Mesh(new THREE.BoxGeometry(angleThick, height, angleSize), matSteel);
            mesh2.position.set(-angleSize/2 + angleThick/2, height/2, 0);
            mesh2.castShadow = true;

            post.add(mesh1, mesh2);
            post.position.set(x, 0, z);
            post.rotation.y = rotY;
            return post;
        };

        const halfW = width / 2;
        const halfD = depth / 2;
        const offset = angleSize / 2; // 기둥 두께 보정

        // 기둥 배치 (안쪽을 바라보도록 회전)
        furnitureGroup.add(createPost(-halfW + offset, -halfD + offset, 0));             // 앞-왼쪽
        furnitureGroup.add(createPost(halfW - offset, -halfD + offset, -Math.PI/2));     // 앞-오른쪽
        furnitureGroup.add(createPost(-halfW + offset, halfD - offset, Math.PI/2));      // 뒤-왼쪽
        furnitureGroup.add(createPost(halfW - offset, halfD - offset, Math.PI));         // 뒤-오른쪽

        // 2. 선반 및 프레임
        const shelfSpacing = (height - 100) / (shelves - 1); // 위아래 50mm 여유

        for (let i = 0; i < shelves; i++) {
            const y = 50 + (i * shelfSpacing);

            // 합판
            const board = new THREE.Mesh(new THREE.BoxGeometry(width - 4, 12, depth - 4), matWood);
            board.position.set(0, y + 6, 0); // 앵글 위에 얹음
            board.castShadow = true;
            board.receiveShadow = true;
            furnitureGroup.add(board);

            // 가로 프레임 (앞/뒤)
            const frameW = new THREE.Mesh(new THREE.BoxGeometry(width, angleSize, angleThick), matSteel);
            
            const fw1 = frameW.clone();
            fw1.position.set(0, y, halfD - angleThick/2);
            furnitureGroup.add(fw1);

            const fw2 = frameW.clone();
            fw2.position.set(0, y, -halfD + angleThick/2);
            furnitureGroup.add(fw2);

            // 깊이 프레임 (좌/우)
            const frameD = new THREE.Mesh(new THREE.BoxGeometry(angleThick, angleSize, depth), matSteel);

            const fd1 = frameD.clone();
            fd1.position.set(halfW - angleThick/2, y, 0);
            furnitureGroup.add(fd1);

            const fd2 = frameD.clone();
            fd2.position.set(-halfW + angleThick/2, y, 0);
            furnitureGroup.add(fd2);
        }

        // ------------------ 치수선 생성 ------------------
        createDimensions(width, depth, height);

        // 씬에 추가
        scene.add(furnitureGroup);
        scene.add(dimGroup);

        // 가격 계산
        calculateCost(width, depth, height, shelves);
    }

    function createDimensions(w, d, h) {
        const color = 0x2563eb; // 파란색
        const offset = 150;     // 가구에서 떨어진 거리

        // 선 그리기 헬퍼
        const drawLine = (p1, p2) => {
            const geo = new THREE.BufferGeometry().setFromPoints([p1, p2]);
            const mat = new THREE.LineBasicMaterial({ color: color });
            return new THREE.Line(geo, mat);
        };

        // 텍스트 생성 헬퍼 (Canvas Texture 사용)
        const createLabel = (text) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 128;
            ctx.fillStyle = "rgba(255,255,255,0.8)";
            ctx.fillRect(0,0,256,128);
            ctx.font = "bold 60px Arial";
            ctx.fillStyle = "blue";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, 128, 64);
            
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            sprite.scale.set(200, 100, 1);
            return sprite;
        };

        // 가로 치수 (바닥 앞쪽)
        const wLine = drawLine(new THREE.Vector3(-w/2, 0, d/2 + offset), new THREE.Vector3(w/2, 0, d/2 + offset));
        const wLabel = createLabel(`W: ${w}`);
        wLabel.position.set(0, 0, d/2 + offset + 50);
        dimGroup.add(wLine, wLabel);

        // 높이 치수 (왼쪽)
        const hLine = drawLine(new THREE.Vector3(-w/2 - offset, 0, 0), new THREE.Vector3(-w/2 - offset, h, 0));
        const hLabel = createLabel(`H: ${h}`);
        hLabel.position.set(-w/2 - offset - 100, h/2, 0);
        dimGroup.add(hLine, hLabel);

        // 깊이 치수 (우측)
        const dLine = drawLine(new THREE.Vector3(w/2 + offset, 0, -d/2), new THREE.Vector3(w/2 + offset, 0, d/2));
        const dLabel = createLabel(`D: ${d}`);
        dLabel.position.set(w/2 + offset + 100, 0, 0);
        dimGroup.add(dLine, dLabel);
    }

    function calculateCost(w, d, h, s) {
        // 간단 견적 로직 (미터당 가격 예시)
        const angleMeter = (h*4 + w*2*s + d*2*s) / 1000;
        const boardArea = (w * d * s) / 1000000;
        
        const price = (angleMeter * 3000) + (boardArea * 25000) + (s * 2000);
        const finalPrice = Math.floor(price / 100) * 100; // 100원 단위 절사
        
        document.getElementById('price-value').innerText = finalPrice.toLocaleString();
    }

    function downloadImage() {
        renderer.render(scene, camera);
        const link = document.createElement('a');
        link.download = 'angle_simulation.png';
        link.href = renderer.domElement.toDataURL();
        link.click();
    }

    function onWindowResize() {
        const container = document.getElementById('canvas-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update(); // OrbitControls 부드러운 감속 효과
        renderer.render(scene, camera);
    }

    // 실행
    init();

</script>
</body>
</html>
